"use strict";(()=>{var e={};e.id=5868,e.ids=[5868],e.modules={53524:e=>{e.exports=require("@prisma/client")},72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},27790:e=>{e.exports=require("assert")},78893:e=>{e.exports=require("buffer")},61282:e=>{e.exports=require("child_process")},84770:e=>{e.exports=require("crypto")},17702:e=>{e.exports=require("events")},32615:e=>{e.exports=require("http")},35240:e=>{e.exports=require("https")},86624:e=>{e.exports=require("querystring")},17360:e=>{e.exports=require("url")},21764:e=>{e.exports=require("util")},71568:e=>{e.exports=require("zlib")},82620:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>b,patchFetch:()=>v,requestAsyncStorage:()=>w,routeModule:()=>g,serverHooks:()=>_,staticGenerationAsyncStorage:()=>x});var n={};r.r(n),r.d(n,{POST:()=>f,dynamic:()=>h});var a=r(79182),o=r(72007),i=r(56719),s=r(93442),c=r(57978),p=r(86023),l=r(83178),u=r(95729),d=r(90391),m=r(29544),y=r(96567);let h="force-dynamic";async function f(e){try{let t;let r=await (0,c.getServerSession)(p.L);if(!r?.user?.companyId||!r?.user?.email)return s.NextResponse.json({error:"Unauthorized"},{status:401});let n=r.user.companyId,a=r.user.email;if(!await l._.companyMembership.findFirst({where:{userId:r.user.id,companyId:n,role:"ADMIN"}}))return s.NextResponse.json({error:"Only company admins can manage billing"},{status:403});let{planKey:o,interval:i,promoCode:h}=await e.json(),f="annual"===i?"year":"month",g=await (0,d.al)(o);if(!g||!g.active)return s.NextResponse.json({error:"Invalid plan"},{status:400});if("free"===o||0===g.priceMonthlyUsdCents){let e=await (0,d.Wp)(n);await l._.companyBilling.update({where:{id:e.id},data:{planKey:"free",status:"active",billingInterval:"month",currentPeriodStart:new Date,currentPeriodEnd:null,cancelAtPeriodEnd:!1}}),console.log("Free plan activated:",{companyId:n,planKey:"free"});let t=process.env.NEXTAUTH_URL||"http://localhost:3000";return s.NextResponse.json({url:`${t}/app/dashboard?billing=success&plan=free`,freePlanActivated:!0})}let w="year"===f?g.stripePriceIdAnnual:g.stripePriceIdMonthly;if(!w)return s.NextResponse.json({error:`Plan not configured for ${f}ly payment. Please contact support.`},{status:500});let x=await l._.company.findUnique({where:{id:n}});if(!x)return s.NextResponse.json({error:"Company not found"},{status:404});if(x.isBlocked)return s.NextResponse.json({error:"Your company has been blocked. Please contact support."},{status:403});let _=await (0,d.Wp)(n),b=!1,v=null,R=null;if(h){if(!(R=await l._.platformCoupon.findFirst({where:{code:h.toUpperCase(),active:!0,archived:!1,OR:[{expiresAt:null},{expiresAt:{gt:new Date}}]}})))return s.NextResponse.json({error:"Invalid or expired promo code"},{status:400});if(R.allowedPlans.length>0&&!R.allowedPlans.includes(o))return s.NextResponse.json({error:`This promo code is not valid for the ${g.name} plan`},{status:400});if(null!==R.maxRedemptions&&R.currentRedemptions>=R.maxRedemptions)return s.NextResponse.json({error:"This promo code has reached its maximum uses"},{status:400});"trial_days"===R.type&&R.trialDays?(b=!0,v="trial",t=R.trialDays):"free_forever"===R.type&&(b=!0,v="free_forever")}if(b&&v&&R){let e=new Date,r="trial"===v&&t?function(e,t){let r=(0,m.Q)(e);return isNaN(t)?(0,y.L)(e,NaN):(t&&r.setDate(r.getDate()+t),r)}(e,t):null;await l._.companyAccessGrant.create({data:{companyId:n,grantType:v,planKey:o,couponId:R.id,startsAt:e,endsAt:r}}),await l._.couponRedemption.create({data:{companyBillingId:_.id,couponCode:R.code,couponType:R.type,source:"checkout"}}),await l._.platformCoupon.update({where:{id:R.id},data:{currentRedemptions:{increment:1}}}),await l._.companyBilling.update({where:{id:_.id},data:{currentCouponCode:R.code}}),console.log("Access grant created (no Stripe):",{companyId:n,planKey:o,grantType:v,endsAt:r,couponCode:R.code});let a=process.env.NEXTAUTH_URL||"http://localhost:3000";return s.NextResponse.json({url:`${a}/app/dashboard?billing=success&grant=${v}`,grantCreated:!0,grantType:v,endsAt:r})}let I=_.stripeCustomerId;I||(I=(await u.Ag.customers.create({email:a,name:x.name,metadata:{companyId:n}})).id,await l._.companyBilling.update({where:{id:_.id},data:{stripeCustomerId:I}}));let S=process.env.NEXTAUTH_URL||"http://localhost:3000",E="per_seat"===g.seatModel?await l._.companyMembership.count({where:{companyId:n,isActive:!0}}):1,P={customer:I,mode:"subscription",line_items:[{price:w,quantity:E}],success_url:`${S}/app/dashboard?billing=success`,cancel_url:`${S}/pricing?checkout=canceled`,metadata:{companyId:n,planKey:o,interval:f,promoCode:h||""},subscription_data:{metadata:{companyId:n,planKey:o,interval:f}}};R?.stripePromoCodeId&&!b&&(P.discounts=[{promotion_code:R.stripePromoCodeId}]);let q=await u.Ag.checkout.sessions.create(P);if(!q.url)return console.error("Stripe returned session without URL:",q.id),s.NextResponse.json({error:"Failed to get checkout URL from Stripe"},{status:500});return console.log("Checkout session created:",{sessionId:q.id,companyId:n,planKey:o,hasUrl:!!q.url}),s.NextResponse.json({url:q.url})}catch(t){console.error("Checkout error:",t);let e="Failed to create checkout session";return t instanceof Error&&(t.message.includes("No such price")?e="Invalid price configuration. Please contact support.":t.message.includes("api_key")&&(e="Payment system configuration error. Please contact support.")),s.NextResponse.json({error:e},{status:500})}}let g=new a.AppRouteRouteModule({definition:{kind:o.x.APP_ROUTE,page:"/api/billing/checkout/route",pathname:"/api/billing/checkout",filename:"route",bundlePath:"app/api/billing/checkout/route"},resolvedPagePath:"/home/ubuntu/make_estimate/nextjs_space/app/api/billing/checkout/route.ts",nextConfigOutput:"",userland:n}),{requestAsyncStorage:w,staticGenerationAsyncStorage:x,serverHooks:_}=g,b="/api/billing/checkout/route";function v(){return(0,i.patchFetch)({serverHooks:_,staticGenerationAsyncStorage:x})}},86023:(e,t,r)=>{r.d(t,{L:()=>s});var n=r(66291),a=r(3390),o=r.n(a),i=r(83178);let s={providers:[(0,n.Z)({name:"credentials",credentials:{email:{label:"Email",type:"email"},password:{label:"Password",type:"password"}},async authorize(e){if(!e?.email||!e?.password)return null;let t=await i._.user.findUnique({where:{email:e.email},include:{memberships:{include:{company:!0}}}});if(!t||!await o().compare(e.password,t.password))return null;await i._.user.update({where:{id:t.id},data:{lastLoginAt:new Date}}).catch(e=>console.error("Failed to update lastLoginAt:",e));let r=t?.memberships?.[0];return{id:t.id,email:t.email,name:t.name,companyId:r?.companyId??null,companyName:r?.company?.name??null,role:r?.role??"MEMBER"}}})],callbacks:{jwt:async({token:e,user:t})=>(t&&(e.id=t.id,e.companyId=t.companyId,e.companyName=t.companyName,e.role=t.role),e),session:async({session:e,token:t})=>(e?.user&&(e.user.id=t.id,e.user.companyId=t.companyId,e.user.companyName=t.companyName,e.user.role=t.role),e)},pages:{signIn:"/login"},session:{strategy:"jwt"},secret:process.env.NEXTAUTH_SECRET}},95729:(e,t,r)=>{r.d(t,{Ag:()=>o,E1:()=>s,_Y:()=>p,gk:()=>c});var n=r(60060),a=r(83178);if(!process.env.STRIPE_SECRET_KEY)throw Error("STRIPE_SECRET_KEY is not set");let o=new n.Z(process.env.STRIPE_SECRET_KEY),i={starter:{key:"starter",name:"Starter",priceId:process.env.STRIPE_STARTER_PRICE_ID,price:19,boqLimit:10,description:"10 BOQ creations per month"},business:{key:"business",name:"Business",priceId:process.env.STRIPE_BUSINESS_PRICE_ID,price:39,boqLimit:null,description:"Unlimited BOQ creations"}};function s(e){return Object.values(i).find(t=>t.priceId===e)}function c(e){return({active:"active",trialing:"trialing",past_due:"past_due",canceled:"canceled",incomplete:"incomplete",incomplete_expired:"incomplete_expired",unpaid:"unpaid",paused:"canceled"})[e]||"incomplete"}async function p(e){try{let t=await a._.companyBilling.findUnique({where:{companyId:e}});if(!t?.stripeSubscriptionId||!t?.planKey){console.log(`[Stripe Sync] No subscription for company ${e}`);return}let r=await a._.billingPlan.findUnique({where:{planKey:t.planKey}});if(!r||"per_seat"!==r.seatModel){console.log(`[Stripe Sync] Plan ${t.planKey} does not use per-seat billing`);return}let n=await a._.companyMembership.count({where:{companyId:e,isActive:!0}}),i=Math.max(1,n),s=await o.subscriptions.retrieve(t.stripeSubscriptionId);if("canceled"===s.status||"incomplete_expired"===s.status){console.log(`[Stripe Sync] Subscription ${t.stripeSubscriptionId} is not active`);return}let c=s.items.data[0];if(!c){console.error(`[Stripe Sync] No subscription item found for ${t.stripeSubscriptionId}`);return}c.quantity!==i&&(await o.subscriptionItems.update(c.id,{quantity:i,proration_behavior:"create_prorations"}),await a._.companyBilling.update({where:{companyId:e},data:{seatQuantity:i}}),console.log(`[Stripe Sync] Updated company ${e} quantity from ${c.quantity} to ${i}`))}catch(t){console.error(`[Stripe Sync] Error syncing quantity for company ${e}:`,t)}}},96567:(e,t,r)=>{function n(e,t){return e instanceof Date?new e.constructor(t):new Date(t)}r.d(t,{L:()=>n})}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),n=t.X(0,[4372,7329,5990,7609,60,391],()=>r(82620));module.exports=n})();