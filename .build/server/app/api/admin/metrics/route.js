"use strict";(()=>{var e={};e.id=7556,e.ids=[7556],e.modules={53524:e=>{e.exports=require("@prisma/client")},72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},27790:e=>{e.exports=require("assert")},78893:e=>{e.exports=require("buffer")},84770:e=>{e.exports=require("crypto")},17702:e=>{e.exports=require("events")},32615:e=>{e.exports=require("http")},35240:e=>{e.exports=require("https")},86624:e=>{e.exports=require("querystring")},17360:e=>{e.exports=require("url")},21764:e=>{e.exports=require("util")},71568:e=>{e.exports=require("zlib")},66129:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>f,patchFetch:()=>h,requestAsyncStorage:()=>w,routeModule:()=>g,serverHooks:()=>M,staticGenerationAsyncStorage:()=>y});var s={};r.r(s),r.d(s,{GET:()=>x,dynamic:()=>d});var a=r(79182),n=r(72007),i=r(56719),o=r(93442),l=r(57978),m=r(86023),u=r(90391),c=r(53609),p=r(66417);let d="force-dynamic";async function x(e){try{let e=await (0,l.getServerSession)(m.L);if(!e?.user?.email||!(0,u.Mz)(e.user.email))return o.NextResponse.json({error:"Unauthorized"},{status:403});let t=(0,c.AT)(),r=(0,p.S2)(),s=new Map;for(let e of t.requests){let t=`${e.method} ${e.endpoint.replace(/\/[a-f0-9-]{36}/g,"/:id")}`,r=s.get(t)||{count:0,totalMs:0,maxMs:0,errors:0,rateLimited:0};r.count++,r.totalMs+=e.durationMs,r.maxMs=Math.max(r.maxMs,e.durationMs),(e.error||e.statusCode>=400)&&r.errors++,429===e.statusCode&&r.rateLimited++,s.set(t,r)}let a=Array.from(s.entries()).map(([e,t])=>({endpoint:e,count:t.count,avgMs:Math.round(t.totalMs/t.count),maxMs:t.maxMs,errors:t.errors,rateLimited:t.rateLimited,errorRate:t.count>0?Math.round(t.errors/t.count*100):0})).sort((e,t)=>t.avgMs-e.avgMs);return o.NextResponse.json({summary:t.summary,endpointStats:a,rateLimitStats:r,recentSlowQueries:t.slowQueries.slice(-20),recentRequests:t.requests.slice(-50)})}catch(e){return console.error("Error fetching metrics:",e),o.NextResponse.json({error:"Failed to fetch metrics"},{status:500})}}let g=new a.AppRouteRouteModule({definition:{kind:n.x.APP_ROUTE,page:"/api/admin/metrics/route",pathname:"/api/admin/metrics",filename:"route",bundlePath:"app/api/admin/metrics/route"},resolvedPagePath:"/home/ubuntu/make_estimate/nextjs_space/app/api/admin/metrics/route.ts",nextConfigOutput:"",userland:s}),{requestAsyncStorage:w,staticGenerationAsyncStorage:y,serverHooks:M}=g,f="/api/admin/metrics/route";function h(){return(0,i.patchFetch)({serverHooks:M,staticGenerationAsyncStorage:y})}},86023:(e,t,r)=>{r.d(t,{L:()=>o});var s=r(66291),a=r(3390),n=r.n(a),i=r(83178);let o={providers:[(0,s.Z)({name:"credentials",credentials:{email:{label:"Email",type:"email"},password:{label:"Password",type:"password"}},async authorize(e){if(!e?.email||!e?.password)return null;let t=await i._.user.findUnique({where:{email:e.email},include:{memberships:{include:{company:!0}}}});if(!t||!await n().compare(e.password,t.password))return null;await i._.user.update({where:{id:t.id},data:{lastLoginAt:new Date}}).catch(e=>console.error("Failed to update lastLoginAt:",e));let r=t?.memberships?.[0];return{id:t.id,email:t.email,name:t.name,companyId:r?.companyId??null,companyName:r?.company?.name??null,role:r?.role??"MEMBER"}}})],callbacks:{jwt:async({token:e,user:t})=>(t&&(e.id=t.id,e.companyId=t.companyId,e.companyName=t.companyName,e.role=t.role),e),session:async({session:e,token:t})=>(e?.user&&(e.user.id=t.id,e.user.companyId=t.companyId,e.user.companyName=t.companyName,e.user.role=t.role),e)},pages:{signIn:"/login"},session:{strategy:"jwt"},secret:process.env.NEXTAUTH_SECRET}},66417:(e,t,r)=>{r.d(t,{Dn:()=>n,S2:()=>m,fp:()=>i,tm:()=>l,um:()=>o});let s=new Map,a=null;function n(e,t){let r=Date.now(),a=r-t.windowMs,n=s.get(e);if(n||(n={timestamps:[],blocked:!1},s.set(e,n)),n.blocked&&n.blockedUntil){if(r<n.blockedUntil){let e=Math.ceil((n.blockedUntil-r)/1e3);return{allowed:!1,remaining:0,resetIn:n.blockedUntil-r,retryAfter:e}}n.blocked=!1,n.blockedUntil=void 0,n.timestamps=[]}if(n.timestamps=n.timestamps.filter(e=>e>a),n.timestamps.length>=t.maxRequests){t.blockDurationMs&&(n.blocked=!0,n.blockedUntil=r+t.blockDurationMs);let s=n.timestamps[0]+t.windowMs-r;return console.log(`[RATE_LIMIT_EXCEEDED] Key: ${e}, Requests: ${n.timestamps.length}/${t.maxRequests}`),{allowed:!1,remaining:0,resetIn:s,retryAfter:Math.ceil(s/1e3)}}return n.timestamps.push(r),{allowed:!0,remaining:t.maxRequests-n.timestamps.length,resetIn:t.windowMs}}setInterval(()=>{let e=Date.now();for(let[t,r]of s.entries())e-(r.timestamps[r.timestamps.length-1]||0)>6e5&&s.delete(t)},3e5);let i={PDF_EXPORT:{windowMs:6e4,maxRequests:10,blockDurationMs:3e4},AUTOSAVE:{windowMs:6e4,maxRequests:60},ITEM_UPDATE:{windowMs:6e4,maxRequests:120},BOQ_CREATE:{windowMs:6e4,maxRequests:20},API_GENERAL:{windowMs:6e4,maxRequests:200}};function o(e,t){return`${e}:${t}`}function l(e){return new Response(JSON.stringify({error:"Too many requests",message:"Rate limit exceeded. Please try again later.",retryAfter:e.retryAfter}),{status:429,headers:{"Content-Type":"application/json","Retry-After":String(e.retryAfter||60),"X-RateLimit-Remaining":String(e.remaining),"X-RateLimit-Reset":String(Math.ceil(e.resetIn/1e3))}})}function m(){let e={};for(let[t,r]of s.entries())e[t]={count:r.timestamps.length,blocked:r.blocked};return e}}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),s=t.X(0,[4372,7329,5990,7609,391],()=>r(66129));module.exports=s})();