"use strict";(()=>{var e={};e.id=7002,e.ids=[7002],e.modules={53524:e=>{e.exports=require("@prisma/client")},72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},27790:e=>{e.exports=require("assert")},78893:e=>{e.exports=require("buffer")},84770:e=>{e.exports=require("crypto")},17702:e=>{e.exports=require("events")},32615:e=>{e.exports=require("http")},35240:e=>{e.exports=require("https")},86624:e=>{e.exports=require("querystring")},17360:e=>{e.exports=require("url")},21764:e=>{e.exports=require("util")},71568:e=>{e.exports=require("zlib")},32781:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>E,patchFetch:()=>g,requestAsyncStorage:()=>y,routeModule:()=>w,serverHooks:()=>h,staticGenerationAsyncStorage:()=>f});var s={};r.r(s),r.d(s,{DELETE:()=>c,GET:()=>p,PUT:()=>m,dynamic:()=>u});var n=r(79182),a=r(72007),i=r(56719),o=r(93442),l=r(83178),d=r(91452);let u="force-dynamic",p=(0,d.g)("/api/boqs/[id]","GET",async(e,{params:t},{companyId:r})=>{let s=await (0,d.p)("boq.findFirst",()=>l._.boq.findFirst({where:{id:t?.id,companyId:r},include:{customer:!0,pdfTheme:!0,coverTemplate:!0,categories:{include:{items:{orderBy:{sortOrder:"asc"}}},orderBy:{sortOrder:"asc"}}}}));return s?o.NextResponse.json(s):o.NextResponse.json({error:"BOQ not found"},{status:404})}),m=(0,d.g)("/api/boqs/[id]","PUT",async(e,{params:t},{companyId:r})=>{let s=await e.json();if(!await l._.boq.findFirst({where:{id:t?.id,companyId:r},select:{id:!0}}))return o.NextResponse.json({error:"BOQ not found"},{status:404});let n={};s?.projectName!==void 0&&(n.projectName=s.projectName),s?.customerId!==void 0&&(n.customerId=s.customerId||null),s?.coverTemplateId!==void 0&&(n.coverTemplateId=s.coverTemplateId||null),s?.pdfThemeId!==void 0&&(n.pdfThemeId=s.pdfThemeId||null),s?.dateMode!==void 0&&(n.dateMode=s.dateMode),s?.preparationDate!==void 0&&(n.preparationDate=s.preparationDate?new Date(s.preparationDate):null),s?.discountEnabled!==void 0&&(n.discountEnabled=s.discountEnabled),s?.discountType!==void 0&&(n.discountType=s.discountType),s?.discountValue!==void 0&&(n.discountValue=s.discountValue),s?.vatEnabled!==void 0&&(n.vatEnabled=s.vatEnabled),s?.vatPercent!==void 0&&(n.vatPercent=s.vatPercent),s?.status!==void 0&&(n.status=s.status);let a=await (0,d.p)("boq.update",()=>l._.boq.update({where:{id:t?.id},data:n,include:{customer:!0,categories:{include:{items:{orderBy:{sortOrder:"asc"}}},orderBy:{sortOrder:"asc"}}}}));return o.NextResponse.json(a)}),c=(0,d.g)("/api/boqs/[id]","DELETE",async(e,{params:t},{companyId:r})=>await l._.boq.findFirst({where:{id:t?.id,companyId:r},select:{id:!0}})?(await (0,d.p)("boq.delete",()=>l._.boq.delete({where:{id:t?.id}})),o.NextResponse.json({success:!0})):o.NextResponse.json({error:"BOQ not found"},{status:404})),w=new n.AppRouteRouteModule({definition:{kind:a.x.APP_ROUTE,page:"/api/boqs/[id]/route",pathname:"/api/boqs/[id]",filename:"route",bundlePath:"app/api/boqs/[id]/route"},resolvedPagePath:"/home/ubuntu/make_estimate/nextjs_space/app/api/boqs/[id]/route.ts",nextConfigOutput:"",userland:s}),{requestAsyncStorage:y,staticGenerationAsyncStorage:f,serverHooks:h}=w,E="/api/boqs/[id]/route";function g(){return(0,i.patchFetch)({serverHooks:h,staticGenerationAsyncStorage:f})}},91452:(e,t,r)=>{r.d(t,{g:()=>l,p:()=>d});var s=r(93442),n=r(57978),a=r(86023),i=r(53609),o=r(66417);function l(e,t,r,l={requireAuth:!0}){return async(d,u)=>{let p,m,c;let w=(0,i.eF)(),y=500;try{let t=null;if(l.requireAuth){if(t=await (0,n.getServerSession)(a.L),!t?.user)return y=401,s.NextResponse.json({error:"Unauthorized"},{status:401});p=t.user?.companyId,m=t.user?.id}if(l.rateLimit&&(p||m)){let t="company"===l.rateLimit.keyBy?p:m,r=(0,o.um)(l.rateLimit.type,t),s=(0,o.Dn)(r,o.fp[l.rateLimit.type]);if(!s.allowed)return y=429,console.log(`[RATE_LIMITED] ${e} ${l.rateLimit.type}:${t}`),(0,o.tm)(s)}let i=await r(d,u,{session:t,companyId:p||"",userId:m||"",timer:w});return y=i.status,i}catch(r){return c=r.message,(0,i.H)(r,{endpoint:e,method:t,companyId:p,userId:m}),y=500,s.NextResponse.json({error:"Internal server error"},{status:500})}finally{(0,i.$B)({endpoint:`${e}${u.params?.id?`/${u.params.id}`:""}`,method:t,companyId:p,userId:m,durationMs:w.elapsed(),statusCode:y,timestamp:new Date,error:c})}}}async function d(e,t){let r=(0,i.eF)();try{let s=await t(),n=r.elapsed();return n>500&&console.warn(`[SLOW_OP] ${e} took ${n}ms`),s}catch(t){throw console.error(`[OP_ERROR] ${e} failed after ${r.elapsed()}ms`),t}}},86023:(e,t,r)=>{r.d(t,{L:()=>o});var s=r(66291),n=r(3390),a=r.n(n),i=r(83178);let o={providers:[(0,s.Z)({name:"credentials",credentials:{email:{label:"Email",type:"email"},password:{label:"Password",type:"password"}},async authorize(e){if(!e?.email||!e?.password)return null;let t=await i._.user.findUnique({where:{email:e.email},include:{memberships:{include:{company:!0}}}});if(!t||!await a().compare(e.password,t.password))return null;await i._.user.update({where:{id:t.id},data:{lastLoginAt:new Date}}).catch(e=>console.error("Failed to update lastLoginAt:",e));let r=t?.memberships?.[0];return{id:t.id,email:t.email,name:t.name,companyId:r?.companyId??null,companyName:r?.company?.name??null,role:r?.role??"MEMBER"}}})],callbacks:{jwt:async({token:e,user:t})=>(t&&(e.id=t.id,e.companyId=t.companyId,e.companyName=t.companyName,e.role=t.role),e),session:async({session:e,token:t})=>(e?.user&&(e.user.id=t.id,e.user.companyId=t.companyId,e.user.companyName=t.companyName,e.user.role=t.role),e)},pages:{signIn:"/login"},session:{strategy:"jwt"},secret:process.env.NEXTAUTH_SECRET}},83178:(e,t,r)=>{r.d(t,{_:()=>a});var s=r(53524),n=r(53609);let a=globalThis.prisma??function(){let e=new s.PrismaClient({log:[{level:"error",emit:"stdout"},{level:"warn",emit:"stdout"}]});return"true"===process.env.ENABLE_QUERY_LOGGING&&e.$on("query",e=>{let t=e.duration;(0,n.mV)({query:e.query,params:e.params,durationMs:t,timestamp:new Date,model:function(e){let t=e.match(/FROM\s+["']?public["']?\.?["']?(\w+)["']?/i),r=e.match(/INSERT\s+INTO\s+["']?public["']?\.?["']?(\w+)["']?/i),s=e.match(/UPDATE\s+["']?public["']?\.?["']?(\w+)["']?/i),n=e.match(/DELETE\s+FROM\s+["']?public["']?\.?["']?(\w+)["']?/i);return(t?.[1]||r?.[1]||s?.[1]||n?.[1]||"unknown").toLowerCase()}(e.query),action:function(e){let t=e.trim().toUpperCase();return t.startsWith("SELECT")?"select":t.startsWith("INSERT")?"insert":t.startsWith("UPDATE")?"update":t.startsWith("DELETE")?"delete":t.startsWith("BEGIN")?"transaction":t.startsWith("COMMIT")?"commit":"other"}(e.query)})}),e}()},53609:(e,t,r)=>{r.d(t,{$B:()=>i,AT:()=>u,H:()=>l,eF:()=>d,mV:()=>o});let s=parseInt(process.env.SLOW_QUERY_THRESHOLD||"500",10),n=[],a=[];function i(e){let t=e.durationMs>1e3?"warn":"info",r={type:"REQUEST_METRICS",...e,timestamp:e.timestamp.toISOString()};"warn"===t?console.warn(`[SLOW_REQUEST] ${e.method} ${e.endpoint} took ${e.durationMs}ms`,JSON.stringify(r)):"true"===process.env.VERBOSE_LOGGING&&console.log(`[REQUEST] ${e.method} ${e.endpoint} - ${e.durationMs}ms`,JSON.stringify(r)),n.push(e),n.length>1e3&&n.shift()}function o(e){e.durationMs>=s&&(console.warn(`[SLOW_QUERY] ${e.model}.${e.action} took ${e.durationMs}ms`,JSON.stringify({type:"SLOW_QUERY",...e,timestamp:e.timestamp.toISOString()})),a.push(e),a.length>1e3&&a.shift())}function l(e,t){console.error(`[ERROR] ${t.action||t.endpoint||"Unknown"}`,JSON.stringify({type:"APP_ERROR",message:e.message,stack:e.stack,name:e.name,...t,timestamp:new Date().toISOString()}))}function d(){let e=performance.now();return{elapsed:()=>Math.round(performance.now()-e)}}function u(){return{requests:n.slice(-100),slowQueries:a.slice(-100),summary:{totalRequests:n.length,slowRequests:n.filter(e=>e.durationMs>1e3).length,slowQueries:a.length,avgRequestTime:n.length>0?Math.round(n.reduce((e,t)=>e+t.durationMs,0)/n.length):0}}}},66417:(e,t,r)=>{r.d(t,{Dn:()=>a,S2:()=>d,fp:()=>i,tm:()=>l,um:()=>o});let s=new Map,n=null;function a(e,t){let r=Date.now(),n=r-t.windowMs,a=s.get(e);if(a||(a={timestamps:[],blocked:!1},s.set(e,a)),a.blocked&&a.blockedUntil){if(r<a.blockedUntil){let e=Math.ceil((a.blockedUntil-r)/1e3);return{allowed:!1,remaining:0,resetIn:a.blockedUntil-r,retryAfter:e}}a.blocked=!1,a.blockedUntil=void 0,a.timestamps=[]}if(a.timestamps=a.timestamps.filter(e=>e>n),a.timestamps.length>=t.maxRequests){t.blockDurationMs&&(a.blocked=!0,a.blockedUntil=r+t.blockDurationMs);let s=a.timestamps[0]+t.windowMs-r;return console.log(`[RATE_LIMIT_EXCEEDED] Key: ${e}, Requests: ${a.timestamps.length}/${t.maxRequests}`),{allowed:!1,remaining:0,resetIn:s,retryAfter:Math.ceil(s/1e3)}}return a.timestamps.push(r),{allowed:!0,remaining:t.maxRequests-a.timestamps.length,resetIn:t.windowMs}}setInterval(()=>{let e=Date.now();for(let[t,r]of s.entries())e-(r.timestamps[r.timestamps.length-1]||0)>6e5&&s.delete(t)},3e5);let i={PDF_EXPORT:{windowMs:6e4,maxRequests:10,blockDurationMs:3e4},AUTOSAVE:{windowMs:6e4,maxRequests:60},ITEM_UPDATE:{windowMs:6e4,maxRequests:120},BOQ_CREATE:{windowMs:6e4,maxRequests:20},API_GENERAL:{windowMs:6e4,maxRequests:200}};function o(e,t){return`${e}:${t}`}function l(e){return new Response(JSON.stringify({error:"Too many requests",message:"Rate limit exceeded. Please try again later.",retryAfter:e.retryAfter}),{status:429,headers:{"Content-Type":"application/json","Retry-After":String(e.retryAfter||60),"X-RateLimit-Remaining":String(e.remaining),"X-RateLimit-Reset":String(Math.ceil(e.resetIn/1e3))}})}function d(){let e={};for(let[t,r]of s.entries())e[t]={count:r.timestamps.length,blocked:r.blocked};return e}}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),s=t.X(0,[4372,7329,5990,7609],()=>r(32781));module.exports=s})();