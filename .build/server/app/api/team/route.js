"use strict";(()=>{var e={};e.id=5750,e.ids=[5750],e.modules={53524:e=>{e.exports=require("@prisma/client")},72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},27790:e=>{e.exports=require("assert")},78893:e=>{e.exports=require("buffer")},61282:e=>{e.exports=require("child_process")},84770:e=>{e.exports=require("crypto")},17702:e=>{e.exports=require("events")},32615:e=>{e.exports=require("http")},35240:e=>{e.exports=require("https")},86624:e=>{e.exports=require("querystring")},17360:e=>{e.exports=require("url")},21764:e=>{e.exports=require("util")},71568:e=>{e.exports=require("zlib")},88968:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>S,patchFetch:()=>v,requestAsyncStorage:()=>b,routeModule:()=>x,serverHooks:()=>g,staticGenerationAsyncStorage:()=>_});var i={};r.r(i),r.d(i,{GET:()=>h,POST:()=>w,dynamic:()=>f});var s=r(79182),a=r(72007),n=r(56719),o=r(93442),p=r(57978),c=r(86023),l=r(83178),u=r(90391),d=r(3390),m=r.n(d),y=r(95729);let f="force-dynamic";async function h(){try{let e=await (0,p.getServerSession)(c.L);if(!e?.user?.companyId)return o.NextResponse.json({error:"Unauthorized"},{status:401});let t=e.user.companyId,r=await l._.companyMembership.findMany({where:{companyId:t},include:{user:{select:{id:!0,email:!0,name:!0,firstName:!0,lastName:!0,isBlocked:!0,createdAt:!0,lastLoginAt:!0}}},orderBy:{createdAt:"asc"}}),i=await (0,u.qf)(t),s=i.planKey?await l._.billingPlan.findUnique({where:{planKey:i.planKey}}):null,a=r.filter(e=>e.isActive).length;return o.NextResponse.json({members:r.map(e=>({id:e.id,userId:e.userId,role:e.role,isActive:e.isActive,createdAt:e.createdAt,user:e.user})),stats:{total:r.length,active:a,limit:s?.maxActiveMembers||null},planKey:i.planKey,seatModel:s?.seatModel||"single"})}catch(e){return console.error("Error fetching team members:",e),o.NextResponse.json({error:"Failed to fetch team members"},{status:500})}}async function w(e){try{let t=await (0,p.getServerSession)(c.L);if(!t?.user?.companyId)return o.NextResponse.json({error:"Unauthorized"},{status:401});let r=t.user.companyId,i=t.user.id,s=await l._.companyMembership.findFirst({where:{userId:i,companyId:r}});if(s?.role!=="ADMIN")return o.NextResponse.json({error:"Only admins can invite team members"},{status:403});let a=await (0,u.qf)(r);if(!a.hasActiveSubscription)return o.NextResponse.json({error:"Active subscription required to add team members",code:"SUBSCRIPTION_REQUIRED"},{status:403});let n=a.planKey?await l._.billingPlan.findUnique({where:{planKey:a.planKey}}):null,d=n?.seatModel||"single";if("single"===d)return o.NextResponse.json({error:"Your plan does not support team members. Upgrade to Business plan.",code:"PLAN_NOT_SUPPORTED"},{status:403});let{email:f,firstName:h,lastName:w,role:x="MEMBER",password:b}=await e.json();if(!f)return o.NextResponse.json({error:"Email is required"},{status:400});let _=await l._.user.findUnique({where:{email:f}});if(_){if(await l._.companyMembership.findFirst({where:{userId:_.id,companyId:r}}))return o.NextResponse.json({error:"User is already a member of this company",code:"ALREADY_MEMBER"},{status:400})}else{let e=await m().hash(b||"temppass123",10);_=await l._.user.create({data:{email:f,name:`${h||""} ${w||""}`.trim()||f.split("@")[0],firstName:h,lastName:w,password:e}})}let g=await l._.companyMembership.create({data:{userId:_.id,companyId:r,role:x,isActive:!0},include:{user:{select:{id:!0,email:!0,name:!0,firstName:!0,lastName:!0,isBlocked:!0,createdAt:!0}}}});return await (0,y._Y)(r),o.NextResponse.json({id:g.id,userId:g.userId,role:g.role,isActive:g.isActive,createdAt:g.createdAt,user:g.user})}catch(e){return console.error("Error inviting team member:",e),o.NextResponse.json({error:"Failed to invite team member"},{status:500})}}let x=new s.AppRouteRouteModule({definition:{kind:a.x.APP_ROUTE,page:"/api/team/route",pathname:"/api/team",filename:"route",bundlePath:"app/api/team/route"},resolvedPagePath:"/home/ubuntu/make_estimate/nextjs_space/app/api/team/route.ts",nextConfigOutput:"",userland:i}),{requestAsyncStorage:b,staticGenerationAsyncStorage:_,serverHooks:g}=x,S="/api/team/route";function v(){return(0,n.patchFetch)({serverHooks:g,staticGenerationAsyncStorage:_})}},86023:(e,t,r)=>{r.d(t,{L:()=>o});var i=r(66291),s=r(3390),a=r.n(s),n=r(83178);let o={providers:[(0,i.Z)({name:"credentials",credentials:{email:{label:"Email",type:"email"},password:{label:"Password",type:"password"}},async authorize(e){if(!e?.email||!e?.password)return null;let t=await n._.user.findUnique({where:{email:e.email},include:{memberships:{include:{company:!0}}}});if(!t||!await a().compare(e.password,t.password))return null;await n._.user.update({where:{id:t.id},data:{lastLoginAt:new Date}}).catch(e=>console.error("Failed to update lastLoginAt:",e));let r=t?.memberships?.[0];return{id:t.id,email:t.email,name:t.name,companyId:r?.companyId??null,companyName:r?.company?.name??null,role:r?.role??"MEMBER"}}})],callbacks:{jwt:async({token:e,user:t})=>(t&&(e.id=t.id,e.companyId=t.companyId,e.companyName=t.companyName,e.role=t.role),e),session:async({session:e,token:t})=>(e?.user&&(e.user.id=t.id,e.user.companyId=t.companyId,e.user.companyName=t.companyName,e.user.role=t.role),e)},pages:{signIn:"/login"},session:{strategy:"jwt"},secret:process.env.NEXTAUTH_SECRET}},95729:(e,t,r)=>{r.d(t,{Ag:()=>a,E1:()=>o,_Y:()=>c,gk:()=>p});var i=r(60060),s=r(83178);if(!process.env.STRIPE_SECRET_KEY)throw Error("STRIPE_SECRET_KEY is not set");let a=new i.Z(process.env.STRIPE_SECRET_KEY),n={starter:{key:"starter",name:"Starter",priceId:process.env.STRIPE_STARTER_PRICE_ID,price:19,boqLimit:10,description:"10 BOQ creations per month"},business:{key:"business",name:"Business",priceId:process.env.STRIPE_BUSINESS_PRICE_ID,price:39,boqLimit:null,description:"Unlimited BOQ creations"}};function o(e){return Object.values(n).find(t=>t.priceId===e)}function p(e){return({active:"active",trialing:"trialing",past_due:"past_due",canceled:"canceled",incomplete:"incomplete",incomplete_expired:"incomplete_expired",unpaid:"unpaid",paused:"canceled"})[e]||"incomplete"}async function c(e){try{let t=await s._.companyBilling.findUnique({where:{companyId:e}});if(!t?.stripeSubscriptionId||!t?.planKey){console.log(`[Stripe Sync] No subscription for company ${e}`);return}let r=await s._.billingPlan.findUnique({where:{planKey:t.planKey}});if(!r||"per_seat"!==r.seatModel){console.log(`[Stripe Sync] Plan ${t.planKey} does not use per-seat billing`);return}let i=await s._.companyMembership.count({where:{companyId:e,isActive:!0}}),n=Math.max(1,i),o=await a.subscriptions.retrieve(t.stripeSubscriptionId);if("canceled"===o.status||"incomplete_expired"===o.status){console.log(`[Stripe Sync] Subscription ${t.stripeSubscriptionId} is not active`);return}let p=o.items.data[0];if(!p){console.error(`[Stripe Sync] No subscription item found for ${t.stripeSubscriptionId}`);return}p.quantity!==n&&(await a.subscriptionItems.update(p.id,{quantity:n,proration_behavior:"create_prorations"}),await s._.companyBilling.update({where:{companyId:e},data:{seatQuantity:n}}),console.log(`[Stripe Sync] Updated company ${e} quantity from ${p.quantity} to ${n}`))}catch(t){console.error(`[Stripe Sync] Error syncing quantity for company ${e}:`,t)}}}};var t=require("../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),i=t.X(0,[4372,7329,5990,7609,60,391],()=>r(88968));module.exports=i})();