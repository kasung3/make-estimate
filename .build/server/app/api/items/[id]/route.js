"use strict";(()=>{var e={};e.id=3616,e.ids=[3616],e.modules={53524:e=>{e.exports=require("@prisma/client")},72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},27790:e=>{e.exports=require("assert")},78893:e=>{e.exports=require("buffer")},84770:e=>{e.exports=require("crypto")},17702:e=>{e.exports=require("events")},32615:e=>{e.exports=require("http")},35240:e=>{e.exports=require("https")},86624:e=>{e.exports=require("querystring")},17360:e=>{e.exports=require("url")},21764:e=>{e.exports=require("util")},71568:e=>{e.exports=require("zlib")},72230:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>h,patchFetch:()=>g,requestAsyncStorage:()=>w,routeModule:()=>c,serverHooks:()=>f,staticGenerationAsyncStorage:()=>y});var s={};r.r(s),r.d(s,{DELETE:()=>p,PUT:()=>d,dynamic:()=>m});var i=r(79182),n=r(72007),a=r(56719),o=r(93442),u=r(83178),l=r(91452);let m="force-dynamic",d=(0,l.g)("/api/items/[id]","PUT",async(e,{params:t},{companyId:r})=>{let s=await e.json();if(!await u._.boqItem.findFirst({where:{id:t?.id,category:{boq:{companyId:r}}},select:{id:!0}}))return o.NextResponse.json({error:"Item not found"},{status:404});let i={};s?.description!==void 0&&(i.description=s.description),s?.unit!==void 0&&(i.unit=s.unit),s?.unitCost!==void 0&&(i.unitCost=s.unitCost),s?.markupPct!==void 0&&(i.markupPct=s.markupPct),s?.quantity!==void 0&&(i.quantity=s.quantity),s?.sortOrder!==void 0&&(i.sortOrder=s.sortOrder),s?.isNote!==void 0&&(i.isNote=s.isNote),s?.noteContent!==void 0&&(i.noteContent=s.noteContent),s?.includeInPdf!==void 0&&(i.includeInPdf=s.includeInPdf);let n=await (0,l.p)("item.update",()=>u._.boqItem.update({where:{id:t?.id},data:i}));return o.NextResponse.json(n)},{requireAuth:!0,rateLimit:{type:"ITEM_UPDATE",keyBy:"user"}}),p=(0,l.g)("/api/items/[id]","DELETE",async(e,{params:t},{companyId:r})=>await u._.boqItem.findFirst({where:{id:t?.id,category:{boq:{companyId:r}}},select:{id:!0}})?(await (0,l.p)("item.delete",()=>u._.boqItem.delete({where:{id:t?.id}})),o.NextResponse.json({success:!0})):o.NextResponse.json({error:"Item not found"},{status:404})),c=new i.AppRouteRouteModule({definition:{kind:n.x.APP_ROUTE,page:"/api/items/[id]/route",pathname:"/api/items/[id]",filename:"route",bundlePath:"app/api/items/[id]/route"},resolvedPagePath:"/home/ubuntu/make_estimate/nextjs_space/app/api/items/[id]/route.ts",nextConfigOutput:"",userland:s}),{requestAsyncStorage:w,staticGenerationAsyncStorage:y,serverHooks:f}=c,h="/api/items/[id]/route";function g(){return(0,a.patchFetch)({serverHooks:f,staticGenerationAsyncStorage:y})}},91452:(e,t,r)=>{r.d(t,{g:()=>u,p:()=>l});var s=r(93442),i=r(57978),n=r(86023),a=r(53609),o=r(66417);function u(e,t,r,u={requireAuth:!0}){return async(l,m)=>{let d,p,c;let w=(0,a.eF)(),y=500;try{let t=null;if(u.requireAuth){if(t=await (0,i.getServerSession)(n.L),!t?.user)return y=401,s.NextResponse.json({error:"Unauthorized"},{status:401});d=t.user?.companyId,p=t.user?.id}if(u.rateLimit&&(d||p)){let t="company"===u.rateLimit.keyBy?d:p,r=(0,o.um)(u.rateLimit.type,t),s=(0,o.Dn)(r,o.fp[u.rateLimit.type]);if(!s.allowed)return y=429,console.log(`[RATE_LIMITED] ${e} ${u.rateLimit.type}:${t}`),(0,o.tm)(s)}let a=await r(l,m,{session:t,companyId:d||"",userId:p||"",timer:w});return y=a.status,a}catch(r){return c=r.message,(0,a.H)(r,{endpoint:e,method:t,companyId:d,userId:p}),y=500,s.NextResponse.json({error:"Internal server error"},{status:500})}finally{(0,a.$B)({endpoint:`${e}${m.params?.id?`/${m.params.id}`:""}`,method:t,companyId:d,userId:p,durationMs:w.elapsed(),statusCode:y,timestamp:new Date,error:c})}}}async function l(e,t){let r=(0,a.eF)();try{let s=await t(),i=r.elapsed();return i>500&&console.warn(`[SLOW_OP] ${e} took ${i}ms`),s}catch(t){throw console.error(`[OP_ERROR] ${e} failed after ${r.elapsed()}ms`),t}}},86023:(e,t,r)=>{r.d(t,{L:()=>o});var s=r(66291),i=r(3390),n=r.n(i),a=r(83178);let o={providers:[(0,s.Z)({name:"credentials",credentials:{email:{label:"Email",type:"email"},password:{label:"Password",type:"password"}},async authorize(e){if(!e?.email||!e?.password)return null;let t=await a._.user.findUnique({where:{email:e.email},include:{memberships:{include:{company:!0}}}});if(!t||!await n().compare(e.password,t.password))return null;await a._.user.update({where:{id:t.id},data:{lastLoginAt:new Date}}).catch(e=>console.error("Failed to update lastLoginAt:",e));let r=t?.memberships?.[0];return{id:t.id,email:t.email,name:t.name,companyId:r?.companyId??null,companyName:r?.company?.name??null,role:r?.role??"MEMBER"}}})],callbacks:{jwt:async({token:e,user:t})=>(t&&(e.id=t.id,e.companyId=t.companyId,e.companyName=t.companyName,e.role=t.role),e),session:async({session:e,token:t})=>(e?.user&&(e.user.id=t.id,e.user.companyId=t.companyId,e.user.companyName=t.companyName,e.user.role=t.role),e)},pages:{signIn:"/login"},session:{strategy:"jwt"},secret:process.env.NEXTAUTH_SECRET}},83178:(e,t,r)=>{r.d(t,{_:()=>n});var s=r(53524),i=r(53609);let n=globalThis.prisma??function(){let e=new s.PrismaClient({log:[{level:"error",emit:"stdout"},{level:"warn",emit:"stdout"}]});return"true"===process.env.ENABLE_QUERY_LOGGING&&e.$on("query",e=>{let t=e.duration;(0,i.mV)({query:e.query,params:e.params,durationMs:t,timestamp:new Date,model:function(e){let t=e.match(/FROM\s+["']?public["']?\.?["']?(\w+)["']?/i),r=e.match(/INSERT\s+INTO\s+["']?public["']?\.?["']?(\w+)["']?/i),s=e.match(/UPDATE\s+["']?public["']?\.?["']?(\w+)["']?/i),i=e.match(/DELETE\s+FROM\s+["']?public["']?\.?["']?(\w+)["']?/i);return(t?.[1]||r?.[1]||s?.[1]||i?.[1]||"unknown").toLowerCase()}(e.query),action:function(e){let t=e.trim().toUpperCase();return t.startsWith("SELECT")?"select":t.startsWith("INSERT")?"insert":t.startsWith("UPDATE")?"update":t.startsWith("DELETE")?"delete":t.startsWith("BEGIN")?"transaction":t.startsWith("COMMIT")?"commit":"other"}(e.query)})}),e}()},53609:(e,t,r)=>{r.d(t,{$B:()=>a,AT:()=>m,H:()=>u,eF:()=>l,mV:()=>o});let s=parseInt(process.env.SLOW_QUERY_THRESHOLD||"500",10),i=[],n=[];function a(e){let t=e.durationMs>1e3?"warn":"info",r={type:"REQUEST_METRICS",...e,timestamp:e.timestamp.toISOString()};"warn"===t?console.warn(`[SLOW_REQUEST] ${e.method} ${e.endpoint} took ${e.durationMs}ms`,JSON.stringify(r)):"true"===process.env.VERBOSE_LOGGING&&console.log(`[REQUEST] ${e.method} ${e.endpoint} - ${e.durationMs}ms`,JSON.stringify(r)),i.push(e),i.length>1e3&&i.shift()}function o(e){e.durationMs>=s&&(console.warn(`[SLOW_QUERY] ${e.model}.${e.action} took ${e.durationMs}ms`,JSON.stringify({type:"SLOW_QUERY",...e,timestamp:e.timestamp.toISOString()})),n.push(e),n.length>1e3&&n.shift())}function u(e,t){console.error(`[ERROR] ${t.action||t.endpoint||"Unknown"}`,JSON.stringify({type:"APP_ERROR",message:e.message,stack:e.stack,name:e.name,...t,timestamp:new Date().toISOString()}))}function l(){let e=performance.now();return{elapsed:()=>Math.round(performance.now()-e)}}function m(){return{requests:i.slice(-100),slowQueries:n.slice(-100),summary:{totalRequests:i.length,slowRequests:i.filter(e=>e.durationMs>1e3).length,slowQueries:n.length,avgRequestTime:i.length>0?Math.round(i.reduce((e,t)=>e+t.durationMs,0)/i.length):0}}}},66417:(e,t,r)=>{r.d(t,{Dn:()=>n,S2:()=>l,fp:()=>a,tm:()=>u,um:()=>o});let s=new Map,i=null;function n(e,t){let r=Date.now(),i=r-t.windowMs,n=s.get(e);if(n||(n={timestamps:[],blocked:!1},s.set(e,n)),n.blocked&&n.blockedUntil){if(r<n.blockedUntil){let e=Math.ceil((n.blockedUntil-r)/1e3);return{allowed:!1,remaining:0,resetIn:n.blockedUntil-r,retryAfter:e}}n.blocked=!1,n.blockedUntil=void 0,n.timestamps=[]}if(n.timestamps=n.timestamps.filter(e=>e>i),n.timestamps.length>=t.maxRequests){t.blockDurationMs&&(n.blocked=!0,n.blockedUntil=r+t.blockDurationMs);let s=n.timestamps[0]+t.windowMs-r;return console.log(`[RATE_LIMIT_EXCEEDED] Key: ${e}, Requests: ${n.timestamps.length}/${t.maxRequests}`),{allowed:!1,remaining:0,resetIn:s,retryAfter:Math.ceil(s/1e3)}}return n.timestamps.push(r),{allowed:!0,remaining:t.maxRequests-n.timestamps.length,resetIn:t.windowMs}}setInterval(()=>{let e=Date.now();for(let[t,r]of s.entries())e-(r.timestamps[r.timestamps.length-1]||0)>6e5&&s.delete(t)},3e5);let a={PDF_EXPORT:{windowMs:6e4,maxRequests:10,blockDurationMs:3e4},AUTOSAVE:{windowMs:6e4,maxRequests:60},ITEM_UPDATE:{windowMs:6e4,maxRequests:120},BOQ_CREATE:{windowMs:6e4,maxRequests:20},API_GENERAL:{windowMs:6e4,maxRequests:200}};function o(e,t){return`${e}:${t}`}function u(e){return new Response(JSON.stringify({error:"Too many requests",message:"Rate limit exceeded. Please try again later.",retryAfter:e.retryAfter}),{status:429,headers:{"Content-Type":"application/json","Retry-After":String(e.retryAfter||60),"X-RateLimit-Remaining":String(e.remaining),"X-RateLimit-Reset":String(Math.ceil(e.resetIn/1e3))}})}function l(){let e={};for(let[t,r]of s.entries())e[t]={count:r.timestamps.length,blocked:r.blocked};return e}}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),s=t.X(0,[4372,7329,5990,7609],()=>r(72230));module.exports=s})();