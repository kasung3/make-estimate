"use strict";exports.id=391,exports.ids=[391],exports.modules={90391:(e,t,r)=>{r.d(t,{Sh:()=>o,qf:()=>c,Wp:()=>d,al:()=>s,Mz:()=>u});var n=r(83178),a=r(29544);function i(e){let t=(0,a.Q)(e);return t.setDate(1),t.setHours(0,0,0,0),t}function l(e){let t=(0,a.Q)(e),r=t.getMonth();return t.setFullYear(t.getFullYear(),r+1,0),t.setHours(23,59,59,999),t}async function s(e){return n._.billingPlan.findUnique({where:{planKey:e}})}async function o(){return n._.billingPlan.findMany({where:{active:!0},orderBy:{sortOrder:"asc"}})}async function c(e){let t,r;let a=new Date,[o,c,u]=await Promise.all([n._.company.findUnique({where:{id:e},select:{isBlocked:!0}}),n._.companyBilling.findUnique({where:{companyId:e}}),n._.companyAccessGrant.findMany({where:{companyId:e,revokedAt:null,OR:[{endsAt:null},{endsAt:{gt:a}}]},orderBy:{createdAt:"desc"}})]),d=o?.isBlocked??!1,m=u.find(e=>"admin_grant"===e.grantType||"free_forever"===e.grantType),p=u.find(e=>"trial"===e.grantType);async function w(t,r){return n._.boqCreationEvent.count({where:{companyId:e,createdAt:{gte:t,lte:r}}})}async function g(e){return e?s(e):null}let h=e=>e?{id:e.id,grantType:e.grantType,planKey:e.planKey,startsAt:e.startsAt,endsAt:e.endsAt,notes:e.notes}:null,A=c?.accessOverride==="free_forever"||c?.accessOverride==="admin_grant",E=!!m;if((A||E)&&!d){let e=m?.planKey||c?.overridePlan||"business",t=await g(e),r=t?.boqLimitPerPeriod??null,n=m?.startsAt||i(a),s=m?.endsAt||l(a),o=await w(n,s);return{hasActiveSubscription:!0,isBlocked:!1,planKey:e,status:"active",currentPeriodStart:n,currentPeriodEnd:s,cancelAtPeriodEnd:!1,boqsUsedThisPeriod:o,boqLimit:r,canCreateBoq:null===r||o<r,hasAdminGrant:!0,hasTrialGrant:!1,accessOverride:c?.accessOverride??(m?"admin_grant":null),trialEndsAt:m?.endsAt??null,accessSource:"admin_override",boqTemplatesLimit:t?.boqTemplatesLimit??null,coverTemplatesLimit:t?.coverTemplatesLimit??null,logoUploadAllowed:t?.logoUploadAllowed??!0,sharingAllowed:t?.sharingAllowed??!0,boqItemsLimit:t?.boqItemsLimit??null,watermarkEnabled:t?.watermarkEnabled??!1,watermarkText:t?.watermarkText??null,activeGrant:h(m)}}if(p&&!d){let e=p.planKey||"starter",t=await g(e),r=t?.boqLimitPerPeriod??null,n=p.startsAt,i=p.endsAt||l(a),s=await w(n,i);return{hasActiveSubscription:!0,isBlocked:!1,planKey:e,status:"trialing",currentPeriodStart:n,currentPeriodEnd:i,cancelAtPeriodEnd:!1,boqsUsedThisPeriod:s,boqLimit:r,canCreateBoq:null===r||s<r,hasAdminGrant:!1,hasTrialGrant:!0,accessOverride:null,trialEndsAt:p.endsAt,accessSource:"grant",boqTemplatesLimit:t?.boqTemplatesLimit??null,coverTemplatesLimit:t?.coverTemplatesLimit??null,logoUploadAllowed:t?.logoUploadAllowed??!0,sharingAllowed:t?.sharingAllowed??!0,boqItemsLimit:t?.boqItemsLimit??null,watermarkEnabled:t?.watermarkEnabled??!1,watermarkText:t?.watermarkText??null,activeGrant:h(p)}}if(c&&"free"===c.planKey&&"active"===c.status&&!d){let e=await g("free"),t=i(a),r=l(a),n=await w(t,r),s=e?.boqLimitPerPeriod??null;return{hasActiveSubscription:!0,isBlocked:!1,planKey:"free",status:"active",currentPeriodStart:t,currentPeriodEnd:r,cancelAtPeriodEnd:!1,boqsUsedThisPeriod:n,boqLimit:s,canCreateBoq:null===s||n<s,hasAdminGrant:!1,hasTrialGrant:!1,accessOverride:null,trialEndsAt:null,accessSource:"free_plan",boqTemplatesLimit:e?.boqTemplatesLimit??null,coverTemplatesLimit:e?.coverTemplatesLimit??null,logoUploadAllowed:e?.logoUploadAllowed??!1,sharingAllowed:e?.sharingAllowed??!1,boqItemsLimit:e?.boqItemsLimit??null,watermarkEnabled:e?.watermarkEnabled??!0,watermarkText:e?.watermarkText??"BOQ generated with MakeEstimate.com",activeGrant:null}}if(!c||!c.planKey||!c.status)return{hasActiveSubscription:!1,isBlocked:d,planKey:null,status:null,currentPeriodStart:null,currentPeriodEnd:null,cancelAtPeriodEnd:!1,boqsUsedThisPeriod:0,boqLimit:null,canCreateBoq:!1,hasAdminGrant:!1,hasTrialGrant:!1,accessOverride:null,trialEndsAt:null,accessSource:null,boqTemplatesLimit:null,coverTemplatesLimit:null,logoUploadAllowed:!1,sharingAllowed:!1,boqItemsLimit:null,watermarkEnabled:!1,watermarkText:null,activeGrant:null};let T=await g(c.planKey),b=["active","trialing"].includes(c.status),f=T?.boqLimitPerPeriod??null;c.currentPeriodStart&&c.currentPeriodEnd&&c.currentPeriodEnd.getTime()>c.currentPeriodStart.getTime()?(t=c.currentPeriodStart,r=c.currentPeriodEnd):(t=i(a),r=l(a),console.warn(`[Billing] Company ${e} has invalid period dates, using calendar month fallback`));let y=await w(t,r),v=!1;return d?v=!1:b&&(v=null===f||y<f),{hasActiveSubscription:b,isBlocked:d,planKey:c.planKey,status:c.status,currentPeriodStart:t,currentPeriodEnd:r,cancelAtPeriodEnd:c.cancelAtPeriodEnd,boqsUsedThisPeriod:y,boqLimit:f,canCreateBoq:v,hasAdminGrant:!1,hasTrialGrant:"trialing"===c.status,accessOverride:c?.accessOverride??null,trialEndsAt:"trialing"===c.status?r:null,accessSource:"subscription",boqTemplatesLimit:T?.boqTemplatesLimit??null,coverTemplatesLimit:T?.coverTemplatesLimit??null,logoUploadAllowed:T?.logoUploadAllowed??!0,sharingAllowed:T?.sharingAllowed??!0,boqItemsLimit:T?.boqItemsLimit??null,watermarkEnabled:T?.watermarkEnabled??!1,watermarkText:T?.watermarkText??null,activeGrant:null}}function u(e){return!!e&&(process.env.PLATFORM_ADMIN_EMAILS?.split(",").map(e=>e.trim().toLowerCase())??[]).includes(e.toLowerCase())}async function d(e){let t=await n._.companyBilling.findUnique({where:{companyId:e}});return t||(t=await n._.companyBilling.create({data:{companyId:e}})),t}},83178:(e,t,r)=>{r.d(t,{_:()=>i});var n=r(53524),a=r(53609);let i=globalThis.prisma??function(){let e=new n.PrismaClient({log:[{level:"error",emit:"stdout"},{level:"warn",emit:"stdout"}]});return"true"===process.env.ENABLE_QUERY_LOGGING&&e.$on("query",e=>{let t=e.duration;(0,a.mV)({query:e.query,params:e.params,durationMs:t,timestamp:new Date,model:function(e){let t=e.match(/FROM\s+["']?public["']?\.?["']?(\w+)["']?/i),r=e.match(/INSERT\s+INTO\s+["']?public["']?\.?["']?(\w+)["']?/i),n=e.match(/UPDATE\s+["']?public["']?\.?["']?(\w+)["']?/i),a=e.match(/DELETE\s+FROM\s+["']?public["']?\.?["']?(\w+)["']?/i);return(t?.[1]||r?.[1]||n?.[1]||a?.[1]||"unknown").toLowerCase()}(e.query),action:function(e){let t=e.trim().toUpperCase();return t.startsWith("SELECT")?"select":t.startsWith("INSERT")?"insert":t.startsWith("UPDATE")?"update":t.startsWith("DELETE")?"delete":t.startsWith("BEGIN")?"transaction":t.startsWith("COMMIT")?"commit":"other"}(e.query)})}),e}()},53609:(e,t,r)=>{r.d(t,{$B:()=>l,AT:()=>u,H:()=>o,eF:()=>c,mV:()=>s});let n=parseInt(process.env.SLOW_QUERY_THRESHOLD||"500",10),a=[],i=[];function l(e){let t=e.durationMs>1e3?"warn":"info",r={type:"REQUEST_METRICS",...e,timestamp:e.timestamp.toISOString()};"warn"===t?console.warn(`[SLOW_REQUEST] ${e.method} ${e.endpoint} took ${e.durationMs}ms`,JSON.stringify(r)):"true"===process.env.VERBOSE_LOGGING&&console.log(`[REQUEST] ${e.method} ${e.endpoint} - ${e.durationMs}ms`,JSON.stringify(r)),a.push(e),a.length>1e3&&a.shift()}function s(e){e.durationMs>=n&&(console.warn(`[SLOW_QUERY] ${e.model}.${e.action} took ${e.durationMs}ms`,JSON.stringify({type:"SLOW_QUERY",...e,timestamp:e.timestamp.toISOString()})),i.push(e),i.length>1e3&&i.shift())}function o(e,t){console.error(`[ERROR] ${t.action||t.endpoint||"Unknown"}`,JSON.stringify({type:"APP_ERROR",message:e.message,stack:e.stack,name:e.name,...t,timestamp:new Date().toISOString()}))}function c(){let e=performance.now();return{elapsed:()=>Math.round(performance.now()-e)}}function u(){return{requests:a.slice(-100),slowQueries:i.slice(-100),summary:{totalRequests:a.length,slowRequests:a.filter(e=>e.durationMs>1e3).length,slowQueries:i.length,avgRequestTime:a.length>0?Math.round(a.reduce((e,t)=>e+t.durationMs,0)/a.length):0}}}},29544:(e,t,r)=>{function n(e){let t=Object.prototype.toString.call(e);return e instanceof Date||"object"==typeof e&&"[object Date]"===t?new e.constructor(+e):new Date("number"==typeof e||"[object Number]"===t||"string"==typeof e||"[object String]"===t?e:NaN)}r.d(t,{Q:()=>n})}};