generator client {
    provider = "prisma-client-js"
    binaryTargets = ["native", "linux-musl-arm64-openssl-3.0.x"]
    output = "/home/ubuntu/make_estimate/nextjs_space/node_modules/.prisma/client"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  ADMIN
  MEMBER
}

enum DiscountType {
  percent
  fixed
}

enum DateMode {
  export_date
  preparation_date
}

enum SubscriptionStatus {
  active
  trialing
  past_due
  canceled
  incomplete
  incomplete_expired
  unpaid
}

enum PlanKey {
  starter
  business
}

enum CouponType {
  trial_days
  free_forever
}

model User {
  id            String   @id @default(cuid())
  email         String   @unique
  password      String
  name          String?
  isBlocked     Boolean  @default(false)
  blockReason   String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  memberships   CompanyMembership[]
}

model Company {
  id                String   @id @default(cuid())
  name              String
  currencySymbol    String   @default("Rs.")
  currencyPosition  String   @default("left")
  defaultVatPercent Float    @default(18)
  isBlocked         Boolean  @default(false)
  blockReason       String?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  memberships       CompanyMembership[]
  customers         Customer[]
  boqs              Boq[]
  pdfCoverTemplates PdfCoverTemplate[]
  pdfThemes         PdfTheme[]
  billing           CompanyBilling?
  boqCreationEvents BoqCreationEvent[]
}

model PdfCoverTemplate {
  id         String   @id @default(cuid())
  companyId  String
  name       String
  configJson Json
  isDefault  Boolean  @default(false)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  company    Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  boqs       Boq[]

  @@index([companyId])
  @@index([companyId, isDefault])
}

model PdfTheme {
  id         String   @id @default(cuid())
  companyId  String
  name       String
  configJson Json
  isDefault  Boolean  @default(false)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  company    Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  boqs       Boq[]

  @@index([companyId])
  @@index([companyId, isDefault])
}

model CompanyMembership {
  id        String   @id @default(cuid())
  userId    String
  companyId String
  role      Role     @default(MEMBER)
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  company   Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@unique([userId, companyId])
}

model Customer {
  id        String   @id @default(cuid())
  companyId String
  name      String
  email     String?
  phone     String?
  address   String?
  createdAt DateTime @default(now())
  company   Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  boqs      Boq[]

  @@index([companyId])
}

model Boq {
  id              String            @id @default(cuid())
  companyId       String
  customerId      String?
  coverTemplateId String?
  pdfThemeId      String?
  projectName     String
  dateMode        DateMode          @default(export_date)
  preparationDate DateTime?
  discountEnabled Boolean           @default(false)
  discountType    DiscountType      @default(percent)
  discountValue   Float             @default(0)
  vatEnabled      Boolean           @default(false)
  vatPercent      Float             @default(18)
  status          String            @default("draft")
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  company         Company           @relation(fields: [companyId], references: [id], onDelete: Cascade)
  customer        Customer?         @relation(fields: [customerId], references: [id], onDelete: SetNull)
  coverTemplate   PdfCoverTemplate? @relation(fields: [coverTemplateId], references: [id], onDelete: SetNull)
  pdfTheme        PdfTheme?         @relation(fields: [pdfThemeId], references: [id], onDelete: SetNull)
  categories      BoqCategory[]

  @@index([companyId])
  @@index([companyId, updatedAt])
}

model BoqCategory {
  id        String    @id @default(cuid())
  boqId     String
  name      String
  sortOrder Int       @default(0)
  createdAt DateTime  @default(now())
  boq       Boq       @relation(fields: [boqId], references: [id], onDelete: Cascade)
  items     BoqItem[]

  @@index([boqId])
  @@index([boqId, sortOrder])
}

model BoqItem {
  id           String      @id @default(cuid())
  categoryId   String
  description  String
  unit         String      @default("")
  unitCost     Float       @default(0)
  markupPct    Float       @default(0)
  quantity     Float       @default(0)
  sortOrder    Int         @default(0)
  isNote       Boolean     @default(false)
  noteContent  String?
  includeInPdf Boolean     @default(true)
  createdAt    DateTime    @default(now())
  category     BoqCategory @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  @@index([categoryId])
  @@index([categoryId, sortOrder])
}

// ============== BILLING MODELS ==============

model CompanyBilling {
  id                   String              @id @default(cuid())
  companyId            String              @unique
  stripeCustomerId     String?             @unique
  stripeSubscriptionId String?             @unique
  planKey              PlanKey?
  status               SubscriptionStatus?
  currentPeriodStart   DateTime?
  currentPeriodEnd     DateTime?
  cancelAtPeriodEnd    Boolean             @default(false)
  createdAt            DateTime            @default(now())
  updatedAt            DateTime            @updatedAt
  company              Company             @relation(fields: [companyId], references: [id], onDelete: Cascade)
}

model BoqCreationEvent {
  id        String   @id @default(cuid())
  companyId String
  boqId     String
  createdAt DateTime @default(now())
  company   Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([companyId, createdAt])
}

model PlatformCoupon {
  id                 String     @id @default(cuid())
  code               String     @unique
  type               CouponType
  trialDays          Int?
  allowedPlans       PlanKey[]
  stripePromoCodeId  String?    @unique
  stripeCouponId     String?
  maxRedemptions     Int?
  currentRedemptions Int        @default(0)
  expiresAt          DateTime?
  active             Boolean    @default(true)
  archived           Boolean    @default(false)
  createdAt          DateTime   @default(now())
  updatedAt          DateTime   @updatedAt

  @@index([code, active, archived])
}

model StripeWebhookEvent {
  id          String   @id
  type        String
  processedAt DateTime @default(now())

  @@index([id])
}
